<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>hadoop源码阅读-configuration</title>
   <meta name="author" content="shuaizki" />
   <!--link href="http://feeds.feedburner.com/tom-preston-werner" rel="alternate" title="Tom Preston-Werner" type="application/atom+xml" /-->
   <meta name="readability-verification" content="QCzSs992GxmRYRKVpPeZ6LE2tS8aYKxsSSQKV8YM"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

<!-- ClickTale Top part -->
<script type="text/javascript">
var WRInitTime=(new Date()).getTime();
</script>
<!-- ClickTale end of Top part -->

<div class="site">
  <div class="title">
    <a href="/">shuaizki</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
<h1>configuration</h1>

<p>实现了Interable&lt;Map.Entry&lt;String, String>>接口和Writable接口</p>

<h2>私有变量</h2>

<p>比较关键的私有变量有</p>

<pre><code>ArrayList&lt;Object&gt; resources; 
记录各个资源文件，configuration里总共有四种形式了  
    String（文件名）， URL, Path(hadoop 自己定义的), 还有inputstream
    在loadresource的时候，用instanceof进行判断然后加载

Set&lt;String&gt; finalParameters; 
    记录了const的哪些配置变量（比如hdfs-site.xml里面的dfs.replication, 被设置成了final）

boolean loadDefaults = true; 用于确定是否加载默认资源(默认加载哦)

private static final WeakHashMap&lt;Configuration,Object&gt; REGISTRY = 
new WeakHashMap&lt;Configuration,Object&gt;(); 各个Conf对象的一个注册表

private static final CopyOnWriteArrayList&lt;String&gt; defaultResources =
new CopyOnWriteArrayList&lt;String&gt;(); 默认资源的一个列表, CopyOnWriteArrayList是线程安全的哦

private boolean storeResource; 是否要存储下面的hashmap

privte HashMap&lt;String, String&gt; updatingResource; 存储某个配置项的来源资源文件

其次是configuration里面的两个个Properties类型的变量,
properties存储所有的配置项目, overlay存储所有被覆盖的配置
还有classloader变量，是当前线程的contextclassloader, 或者是当前类的classloader（如果前者为空的话）
</code></pre>

<h2>方法</h2>

<p>首先用一个静态块加载了"core-default.xml"和"core-site.xml"两个资源文件</p>

<h3>线程安全</h3>

<p>由于configuration是线程安全的，因而注意代码里面的同步，有趣的是在configuration的一个构造函数Configuration(Configutaion other)中，看到了这样的代码</p>

<pre><code>this.resources = (ArrayList)other.resources.clone();
synchronized(other) {
 if (other.properties != null) {
   this.properties = (Properties)other.properties.clone();
 }

 if (other.overlay!=null) {
   this.overlay = (Properties)other.overlay.clone();
 }
}

this.finalParameters = new HashSet&lt;String&gt;(other.finalParameters);
</code></pre>

<p>让人困惑的是为什么针对resources和finalParameters的操作并没有被synchronized</p>

<h3>资源加载相关函数</h3>

<p>properties并非启动或者生成对象的时候加载的，而是在需要的时候才会加载，因而当有新的资源需要载入的时候，需要一个函数清理当前的properties 和 finalParameters , 这样在需要用到的时候才能重新加载.其实这个函数很简单，设置properties == null ，clear finalParameters就行了</p>

<h3>get 和 set函数</h3>

<h4>基本类型和enum</h4>

<p>各种各样的get和set函数，五花八门，针对各个基本类型
都是针对properties进行操作的，由于Properties这个类本身是线程安全的，因而各种函数都是天然的线程安全函数---除了一个需要特别实现的函数</p>

<pre><code>private synchronized Properties getOverlay() {
if (overlay==null){
  overlay=new Properties();
}
return overlay;
</code></pre>

<p>  }</p>

<h4>IntegerRangs类和函数</h4>

<p>将字符串转化为整数区间的类，目前还不清楚具体的作用是什么，只看到了一个isIncluded， 竟然是用遍历所有range来判断是否被包含在内的，感觉相当弱。。。。<br/>
随着这个类提供的是一个getRange函数,获取IntegerRanges结果。
值得注意的是这里的IntegerRangs使用的是静态内部类，有关静态内部类的好处看<a href="http://book.51cto.com/art/201202/317517.htm">这里</a></p>

<h4>get class</h4>

<p>剩下的get函数就只剩下getclass系列了<br/>
封装的很全面，不过实际上还是调用Class.forName(name, true, classloader)<br/>
有一个不错的实现之前完全没见过，就是载入实现了某个接口的类，函数如下</p>

<pre><code>public &lt;U&gt; Class&lt;? extends U&gt; getClass(String name, 
                                     Class&lt;? extends U&gt; defaultValue, 
                                     Class&lt;U&gt; xface) {
try {
  Class&lt;?&gt; theClass = getClass(name, defaultValue);
  if (theClass != null &amp;&amp; !xface.isAssignableFrom(theClass))
    throw new RuntimeException(theClass+" not "+xface.getName());
  else if (theClass != null)
    return theClass.asSubclass(xface);
  else
    return null;
} catch (Exception e) {
  throw new RuntimeException(e);
}
}
运用了isAssignableFrom函数的特性, 判断当前Class是否是theclass the superclass 或者是 superinterface(两个类相等也返回true哦)
</code></pre>

<h4>get resouce</h4>

<p>核心函数是classloader.getResource</p>

<h4>loadResource</h4>

<p>对xml的解析用的是javax.xml.parsers<br/>
loadResource(Properties, Object, boolean)
是个递归函数，每次函数被调用，都会对 Element root进行赋值，然后判断root的tagname是否是configuration，如果不是的话会出直接退出，如果是，逐个对root的childnode进行解析<br/>
如果子节点的tag那么是configuration，调用loadresource返回上面那个步骤。否则判断子节点的tagnode是否为property（真麻烦啊。。。不过这样强有力的保障了正确性）， blah…blah…解析子节点并放在properties和finalParmeter里面</p>

<h5>总体的感觉是封装的很标准，也有很多值得借鉴的实现。不过因为功力不够的缘故，留下了一些疑问：</h5>

<h5>1、某些为了保证线程安全而加的synchronized段，比如上面提到的那段</h5>

<h5>2、不同类型的classloader用起来有什么区别，比如configuration里涉及到的两种类型</h5>

<h5>3、configuration中用到hashCode的两个函数getLocalPath和getFile</h5>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>01 Jul 2013</span> &raquo; <a href="/2013/07/01/datafu.html">dataFu印象</a></li>
    
      <li><span>22 Jun 2013</span> &raquo; <a href="/2013/06/22/introduction-to-jpype.html">Jpype的一些事儿</a></li>
    
      <li><span>13 Jun 2013</span> &raquo; <a href="/2013/06/13/first-artical.html">博客动起来了</a></li>
    
  </ul>
</div>
  
  <div class="footer">
    <div class="contact">
      <p>
        Shuaizki<br />
        shuaizki@gmail.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/shuaizki/">github.com/shuaizki</a><br />
        <!--a href="http://twitter.com/mojombo/">twitter.com/mojombo</a><br /-->
        <!--a href="http://flickr.com/photos/mojombo/">flickr.com/photos/mojombo</a-->
      </p>
    </div>
    <!--div class="rss">
      <a href="http://feeds.feedburner.com/tom-preston-werner">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div-->
  </div>
</div>

<!--a href="http://github.com/mojombo"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a -->

<!-- ClickTale Bottom part -->
<div id="ClickTaleDiv" style="display: none;"></div>
<script type="text/javascript">
if(document.location.protocol!='https:')
  document.write(unescape("%3Cscript%20src='http://s.clicktale.net/WRb.js'%20type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
if(typeof ClickTale=='function') ClickTale(206,0.3,"www03");
</script>
<!-- ClickTale end of Bottom part -->

<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-6016902-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->

</body>
</html>
