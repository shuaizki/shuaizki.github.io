<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>java enum singleton and related safe problems</title>
   <meta name="author" content="shuaizki" />
   <!--link href="http://feeds.feedburner.com/tom-preston-werner" rel="alternate" title="Tom Preston-Werner" type="application/atom+xml" /-->
   <meta name="readability-verification" content="QCzSs992GxmRYRKVpPeZ6LE2tS8aYKxsSSQKV8YM"/>

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

   <!-- Typekit -->
   <script type="text/javascript" src="http://use.typekit.com/jpd0pfm.js"></script>
   <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>

<!-- ClickTale Top part -->
<script type="text/javascript">
var WRInitTime=(new Date()).getTime();
</script>
<!-- ClickTale end of Top part -->

<div class="site">
  <div class="title">
    <a href="/">shuaizki</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
<p>晚上在stackoverflow上闲晃，查找google的java库的相关信息的时候，看到了用enum singleton单例的写法,就顺便花时间了解了一下几个单例:<br/>
单例要保证的是一个进程只有一个实例，一般性的写法是</p>

<pre><code>class Singleton {
    private static Singleton singleton = new Singleton();

    private Singleton() {}

    public Singleton getSingleton()
    {
        return singleton;
    }
}

还有lazy implementation, 就是我常用的bob方法，其他古老的方法就不说了
class Singleton {
    private static class SingleHolder {
        public static Singleton singleton = new Singleton();
    }

    private Singleton() {}; 

    public Singleton getSingleton()
    {
        return SingleHolder.singleton;
    }
}
只要不访问SingleHolder就不会触发singleton的构造，所以不访问getSinleton()函数是不会生成单例的.

而enum实现单例更简单一些
enum Singleton {
    INSTANCE;

    Singleton() {
    //your code
    };

    private xxx;
}
</code></pre>

<p>最古老的方法不可考了也不想考了，中间了方法是我一直在稀里糊涂用着但是不知道为什么的方法，现在想想唯一的好处就是lazy implementation和不用加synchornized关键字的线程安全。至于知道enum 的这种实现方法，是看到stackoverflow上的大牛鄙视一个小菜鸟的时候顺便学到的（大牛对小菜一通鄙视，从封装到singleton，最后索性来了一句jactually everything you said is wrong, blah, blah, blah, read effective java, blah, blah，我自己也顺便中了一枪）。</p>

<p>采用前两种方法会产生两个安全性问题：1、reflection attack 和 2、deserialization attack。第一种说的是可以通过反射调用似有函数，从而产生新的instance，后者说的是通过序列化和反序列化能产生新的实例，这样赤裸裸的对单例的侵犯是难以忍受的，所以衍生出了一些办法来对付这俩问题，对于前者，<a href="http://initbinder.com/articles/hack_any_java_class_using_reflection_attack.html">这篇讲reflection attack的blog</a>里有详细的介绍，对于后者，readReslove里抛异常之类的奇思妙想也是比比皆是。<br/>
但是如果用enum来实现单例的话直接就能解决这俩问题，不信你看java这个语言的设定----<a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-8.html#jls-8.9">enum specification</a></p>

<pre><code>**The final clone method in Enum ensures that enum constants can never be cloned, and the special treatment by the serialization mechanism ensures that duplicate instances are never created as a result of deserialization. Reflective instantiation of enum types is prohibited. Together, these four things ensure that no instances of an enum type exist beyond those defined by the enum constants.**
</code></pre>

<p>最后附上wiki里面对java singleton的<a href="http://en.wikipedia.org/wiki/Singleton_pattern">详尽介绍</a><br/>
还有enum在java中的<a href="http://www.cnblogs.com/frankliiu-java/archive/2010/12/07/1898721.html">具体实现</a>，一篇不错的中文文章.</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>06 Jul 2013</span> &raquo; <a href="/2013/07/06/book-review.html">中国国民性演变历程读后感</a></li>
    
      <li><span>05 Jul 2013</span> &raquo; <a href="/2013/07/05/two_blogs.html">不吹会死</a></li>
    
      <li><span>04 Jul 2013</span> &raquo; <a href="/2013/07/04/g%2B%2B-things2.html">osx下编译so的困难记录</a></li>
    
  </ul>
</div>
  
  <div class="footer">
    <div class="contact">
      <p>
        Shuaizki<br />
        shuaizki@gmail.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/shuaizki/">github.com/shuaizki</a><br />
        <!--a href="http://twitter.com/mojombo/">twitter.com/mojombo</a><br /-->
        <!--a href="http://flickr.com/photos/mojombo/">flickr.com/photos/mojombo</a-->
      </p>
    </div>
    <!--div class="rss">
      <a href="http://feeds.feedburner.com/tom-preston-werner">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div-->
  </div>
</div>

<!--a href="http://github.com/mojombo"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a -->

<!-- ClickTale Bottom part -->
<div id="ClickTaleDiv" style="display: none;"></div>
<script type="text/javascript">
if(document.location.protocol!='https:')
  document.write(unescape("%3Cscript%20src='http://s.clicktale.net/WRb.js'%20type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
if(typeof ClickTale=='function') ClickTale(206,0.3,"www03");
</script>
<!-- ClickTale end of Bottom part -->

<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-6016902-1");
pageTracker._trackPageview();
</script>
<!-- Google Analytics end -->

</body>
</html>
